<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Membros</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

  <style>
    .video-top {
      position: relative;
      width: 100%;
      height: 180px;
      overflow: hidden;
      z-index: 10;
    }
    .video-top video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cursor-pointer {
      cursor: pointer;
    }
 #membroSection.hidden {
      display: none !important;
 }
  </style>
</head>
<body class="bg-gray-100"></body>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('Service Worker registrado!'))
      .catch(err => console.error('Erro ao registrar SW:', err));
  }
</script>

<body class="bg-gray-200">



<!-- LOGIN & CADASTRO -->
  <div id="authSection" class="flex min-h-screen items-center justify-center p-4">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-sm">
      
      <!-- Login -->
      <div id="loginForm">
        <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
        <input id="emailInput" type="email" placeholder="Email" class="w-full mb-3 px-4 py-2 border rounded" />
        <input id="passwordInput" type="password" placeholder="Senha" class="w-full mb-4 px-4 py-2 border rounded" />
        <button id="btnLogin" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Entrar</button>
        <p id="loginError" class="text-red-500 mt-2 hidden text-sm text-center">Email ou senha incorretos.</p>
        <p class="text-center mt-4 text-sm">Não tem conta? <span id="showCadastro" class="text-blue-600 cursor-pointer hover:underline">Cadastre-se aqui</span></p>
      </div>

      <!-- Cadastro -->
      <div id="cadastroForm" class="hidden">
        <h2 class="text-2xl font-bold mb-4 text-center">Cadastro</h2>
        <input id="cadEmailInput" type="email" placeholder="Email" class="w-full mb-3 px-4 py-2 border rounded" />
        <input id="cadSenhaInput" type="password" placeholder="Senha (mínimo 6 caracteres)" class="w-full mb-3 px-4 py-2 border rounded" />
        <input id="cadConfirmaSenhaInput" type="password" placeholder="Confirme a senha" class="w-full mb-4 px-4 py-2 border rounded" />
        <button id="btnCadastro" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Cadastrar</button>
        <p id="cadastroError" class="text-red-500 mt-2 hidden text-sm text-center"></p>
        <p class="text-center mt-4 text-sm">Já tem conta? <span id="showLogin" class="text-blue-600 cursor-pointer hover:underline">Faça login aqui</span></p>
      </div>

    </div>
  </div>

  <!-- SEÇÃO MEMBROS (escondida até login) -->
  <section id="membroSection" class="hidden">

    <!-- Cabeçalho -->
    <!-- TÍTULO COM FAÍSCAS -->
    <div class="flex items-center gap-3 mb-0">
      <img src="logo.png" class="w-12 h-12 opacity-90" alt="Logo">
      <div id="tituloContainer">
        <h1 id="titulo" class="text-white font-extrabold text-5xl drop-shadow-lg"></h1>
      </div>
    </div>


    
<style>
  #tituloContainer {
  position: relative;
  display: inline-block;
}


#titulo {
  text-shadow: 0 0 10px #00f6ff, 0 0 20px #00f6ff, 0 0 30px #0088ff;
  white-space: nowrap;
  overflow: hidden;
  border-right: 0px solid #00f6ff;
  animation: blink 0.7s infinite;
  margin-bottom: -5;
  margin: 0 !important;
  padding: 0 !important;
}


@keyframes blink {
  50% { border-color: transparent; }
}

.spark {
  position: absolute;
  width: 6px;
  height: 6px;
  background: #00f6ff;
  border-radius: 50%;
  opacity: 0.9;
  filter: blur(1px);
  pointer-events: none;
  animation: sparkMove 0.7s forwards;
}

@keyframes sparkMove {
  0%   { transform: translate(0,0) scale(1); opacity: 1; }
  100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; }
}
</style>

<script>
function typeWriterWithSparks(container, element, text, speed = 100) {
  element.textContent = "";
  let i = 0;

  function type() {
    if (i < text.length) {
      element.textContent += text.charAt(i);

      // Criar faíscas
      for (let j = 0; j < 3; j++) {
        const spark = document.createElement("span");
        spark.className = "spark";
        spark.style.left = `${Math.random() * element.offsetWidth}px`;
        spark.style.top = `${Math.random() * element.offsetHeight}px`;
        spark.style.setProperty("--x", `${Math.random() * 80 - 40}px`);
        spark.style.setProperty("--y", `${-Math.random() * 80 - 20}px`);
        container.appendChild(spark);
        setTimeout(() => spark.remove(), 700);
      }

      i++;
      setTimeout(type, speed);
    }
  }
  type();
}

// TESTE → roda quando a página abrir
window.onload = () => {
  const titulo = document.getElementById("titulo");
  const container = document.getElementById("tituloContainer");
  typeWriterWithSparks(container, titulo, "MEMBROS RAÇA GUERREIRA", 100);
};
</script>



    <!-- Botão Sair -->
    <div class="flex justify-end max-w-7xl mx-auto px-4 py-4">
      <button id="btnSair" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Sair</button>
    </div>

    <!-- Pesquisa -->
    <div class="max-w-7xl mx-auto px-4 mb-4">
      <input type="text" id="searchInput" placeholder="Pesquisar por nome, apelido, idade, sexo, cidade, frequência..." class="w-full p-2 border rounded shadow-sm" />
    </div>

  

<script>
/* ==================== Cálculo automático da idade ==================== */
document.getElementById("data").addEventListener("change", function() {
  const nascimento = new Date(this.value);
  const hoje = new Date();

  if (!isNaN(nascimento)) {
    let idade = hoje.getFullYear() - nascimento.getFullYear();
    const m = hoje.getMonth() - nascimento.getMonth();
    if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) {
      idade--;
    }
    document.getElementById("idade").value = idade;
  } else {
    document.getElementById("idade").value = "";
  }
});
</script>


    <!-- Formulário de membros -->
    <div class="max-w-7xl mx-auto px-4 bg-white p-4 rounded shadow grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
  <input id="nome" placeholder="Nome" class="p-2 border rounded"/>
  <input id="apelido" placeholder="Apelido" class="p-2 border rounded"/>

  <!-- Data de nascimento e Idade -->
  <div>
    <label for="nascimento" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
    <input id="nascimento" type="date" class="p-2 border rounded w-full"/>
  </div>

  <div>
    <label for="idade" class="block text-sm font-medium text-gray-700">Idade</label>
    <input id="idade" placeholder="Idade" class="p-2 border rounded w-full" readonly/>
  </div>

  <div>
    <label for="sexo" class="block text-sm font-medium text-gray-700">Sexo</label>
    <select id="sexo" class="p-2 border rounded w-full">
      <option>Masculino</option>
      <option>Feminino</option>
      <option>Outro</option>
    </select>
  </div>

  <input id="cidade" placeholder="Cidade/Bairro" class="p-2 border rounded"/>
  <input id="corda" placeholder="Corda" class="p-2 border rounded"/>
  <input id="tempo" placeholder="Tempo de treino" class="p-2 border rounded"/>
  <input id="frequencia" placeholder="Frequência" class="p-2 border rounded"/>
  <input id="telefone" placeholder="Telefone" class="p-2 border rounded"/>
  <input id="responsavel" placeholder="Responsável" class="p-2 border rounded"/>
  <input id="autorizacao" placeholder="Autorização" class="p-2 border rounded"/>
  <input id="data" type="date" class="p-2 border rounded"/>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const nascimentoInput = document.getElementById("nascimento");
  const idadeInput = document.getElementById("idade");

  nascimentoInput.addEventListener("change", function () {
    const nascimento = new Date(this.value);
    const hoje = new Date();

    if (!isNaN(nascimento)) {
      let idade = hoje.getFullYear() - nascimento.getFullYear();
      const m = hoje.getMonth() - nascimento.getMonth();
      if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) {
        idade--;
      }
      idadeInput.value = idade;
    } else {
      idadeInput.value = "";
    }
  });
});
</script>


 <!-- Status -->
<div class="col-span-1 sm:col-span-3 flex flex-wrap items-center gap-3 mt-1">
  <span class="font-semibold">Status:</span>
  <button id="btnAtivo" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Ativo</button>
  <button id="btnDesativado" class="bg-red-700 text-white px-3 py-1 rounded hover:bg-red-800">Desativado</button>
  <span id="statusSelecionado" class="ml-2 font-bold text-blue-700">Ativo</span>
</div>

<!-- Botões Cadastrar / Exportar -->
<div class="max-w-7xl mx-auto px-4 flex flex-col sm:flex-row justify-center gap-4 mb-6">
  <button id="btnCadastrar" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Cadastrar Membro</button>
  <button id="btnExportar" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Exportar CSV</button>
</div>

<!-- Contador -->
<div class="grid grid-cols-2 gap-4 mb-6">
  <div id="ativosBox" class="bg-white p-4 rounded-2xl shadow text-center font-bold text-green-700 text-lg">Ativos: 0</div>
  <div id="desativadosBox" class="bg-white p-4 rounded-2xl shadow text-center font-bold text-red-700 text-lg">Desativados: 0</div>
</div>

<!-- Tabela -->
<!-- === Tabela com Data de Nascimento === -->
<div class="max-w-7xl mx-auto px-4 overflow-x-auto mb-6">
  <table id="tabelaMembros" class="min-w-full border border-black text-sm sm:text-base bg-white">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2 border border-black">Nome</th>
        <th class="p-2 border border-black">Apelido</th>
        <th class="p-2 border border-black">Nascimento</th>
        <th class="p-2 border border-black">Idade</th>
        <th class="p-2 border border-black">Sexo</th>
        <th class="p-2 border border-black">Cidade</th>
        <th class="p-2 border border-black">Corda</th>
        <th class="p-2 border border-black">Tempo</th>
        <th class="p-2 border border-black">Frequência</th>
        <th class="p-2 border border-black">Telefone</th>
        <th class="p-2 border border-black">Responsável</th>
        <th class="p-2 border border-black">Autorização</th>
        <th class="p-2 border border-black">Status</th>
        <th class="p-2 border border-black">Data Cadastro</th>
        <th class="p-2 border border-black">Última Saída</th>
        <th class="p-2 border border-black">Ações</th>
      </tr>
    </thead>
    <tbody id="tabelaMembrosCorpo"></tbody>
  </table>
</div>

<!-- Gráfico -->
<div class="max-w-md mx-auto bg-white p-4 rounded-lg shadow-md mb-6">
  <h2 class="text-xl font-semibold mb-4 text-center">Distribuição de Membros</h2>
  <canvas id="graficoMembros"></canvas>
</div>

<!-- APP (Firebase v10 modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzj_PW0iboc8IJPfeuI5TP5ugia-Wbzw4",
  authDomain: "racaguerreira-e7224.firebaseapp.com",
  projectId: "racaguerreira-e7224",
  storageBucket: "racaguerreira-e7224.appspot.com",
  messagingSenderId: "194977970184",
  appId: "1:194977970184:web:e5ffc3232d720ea710f9bd",
  measurementId: "G-WQ9JGE53XP"
};


const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let unsubscribeMembros = null;
let grafico = null;
let statusAtual = "Ativo";
let editandoTr = null;
let editandoDocId = null;

// Funções auxiliares
function limparCampos() {
  const campos = ["nome","apelido","idade","sexo","cidade","corda","tempo","frequencia","telefone","responsavel","autorizacao","data"];
  campos.forEach(id => {
    const el = document.getElementById(id);
    if(el.tagName==="SELECT") el.selectedIndex=0;
    else el.value="";
  });
  statusAtual="Ativo";
  document.getElementById("statusSelecionado").textContent="Ativo";
  editandoTr = null; editandoDocId = null;
  document.getElementById("btnCadastrar").textContent="Cadastrar Membro";
}

function adicionarLinhaTabela(docId, dados) {
  const tr = document.createElement("tr");
  tr.dataset.docId = docId;
  const campos = ["nome","apelido","idade","sexo","cidade","corda","tempo","frequencia","telefone","responsavel","autorizacao","data","status"];
  campos.forEach(campo=>{
    const td = document.createElement("td");
    td.className="border px-2 py-1 text-center";
    if(campo==="data" && dados[campo]) td.textContent = new Date(dados[campo]).toLocaleDateString("pt-BR");
    else td.textContent = dados[campo]??"";
    tr.appendChild(td);
  });
  const tdAcoes = document.createElement("td");
  tdAcoes.className="border px-2 py-1 text-center";
  const wrap = document.createElement("div");
  wrap.className="flex justify-center gap-2";
  const btnEditar = document.createElement("button");
  btnEditar.textContent="Editar";
  btnEditar.className="bg-yellow-400 hover:bg-yellow-500 px-2 rounded text-black";
  btnEditar.onclick=()=> editarMembro(docId,tr);
  const btnExcluir = document.createElement("button");
  btnExcluir.textContent="Excluir";
  btnExcluir.className="bg-red-600 hover:bg-red-700 px-2 rounded text-white";
  btnExcluir.onclick=()=> excluirMembro(docId);
  wrap.appendChild(btnEditar); wrap.appendChild(btnExcluir);
  tdAcoes.appendChild(wrap);
  tr.appendChild(tdAcoes);
  document.getElementById("tabelaMembrosCorpo").appendChild(tr);
}

async function editarMembro(docId,tr){
  const snap = await getDoc(doc(db,"membros",docId));
  if(!snap.exists()){ alert("Documento não encontrado"); return; }
  const dados = snap.data();
  const campos = ["nome","apelido","idade","sexo","cidade","corda","tempo","frequencia","telefone","responsavel","autorizacao","data"];
  campos.forEach(id=>document.getElementById(id).value=dados[id]||"");
  statusAtual=dados.status||"Ativo";
  document.getElementById("statusSelecionado").textContent=statusAtual;
  editandoTr=tr; editandoDocId=docId;
  document.getElementById("btnCadastrar").textContent="Salvar Alterações";
}

async function excluirMembro(docId){
  if(!confirm("Excluir este membro?")) return;
  try{ await deleteDoc(doc(db,"membros",docId)); alert("Excluído com sucesso!"); }catch(e){ alert("Erro: "+e.message); }
}

function gerarGrafico(membros){
  const ganhos={}, perdas={};
  membros.forEach(d=>{
    if(d.status==="Ativo"&&d.data){ const dt=new Date(d.data); const mesAno=dt.toLocaleString("pt-BR",{month:"short",year:"numeric"}); ganhos[mesAno]=(ganhos[mesAno]||0)+1; }
    if(d.status==="Desativado"&&d.data){ const dt=new Date(d.data); const mesAno=dt.toLocaleString("pt-BR",{month:"short",year:"numeric"}); perdas[mesAno]=(perdas[mesAno]||0)+1; }
  });
  const meses=[...new Set([...Object.keys(ganhos),...Object.keys(perdas)])].sort((a,b)=>new Date("01 "+a)-new Date("01 "+b));
  const dadosGanhos=meses.map(m=>ganhos[m]||0);
  const dadosPerdas=meses.map(m=>perdas[m]||0);
  const ctx=document.getElementById("graficoMembros").getContext("2d");
  if(grafico) grafico.destroy();
  grafico=new Chart(ctx,{type:"bar",data:{labels:meses,datasets:[{label:"Entraram",data:dadosGanhos,backgroundColor:"rgba(34,197,94,0.7)",borderColor:"rgba(34,197,94,1)",borderWidth:1},{label:"Saíram",data:dadosPerdas,backgroundColor:"rgba(239,68,68,0.7)",borderColor:"rgba(239,68,68,1)",borderWidth:1}]},options:{responsive:true,plugins:{legend:{position:"top"},title:{display:true,text:"Entradas e Saídas Mensais",font:{size:18,weight:"bold"}}},scales:{x:{title:{display:true,text:"Mês",font:{size:14}}},y:{beginAtZero:true,title:{display:true,text:"Quantidade",font:{size:14}}}}}});
}

// Listener de membros
function iniciarListenerMembros(){
  if(unsubscribeMembros) unsubscribeMembros();
  const q=query(collection(db,"membros"),orderBy("nome"));
  unsubscribeMembros=onSnapshot(q,(snap)=>{
    const corpo=document.getElementById("tabelaMembrosCorpo");
    corpo.innerHTML="";
    let ativos=0, desativados=0;
    const membrosArray=[];
    snap.forEach(docu=>{
      const dados=docu.data();
      membrosArray.push(dados);
      adicionarLinhaTabela(docu.id,dados);
      if(dados.status==="Ativo") ativos++; else desativados++;
    });
    document.getElementById("ativosBox").textContent=`Ativos: ${ativos}`;
    document.getElementById("desativadosBox").textContent=`Desativados: ${desativados}`;
    gerarGrafico(membrosArray);
  });
}

// Eventos Auth
document.getElementById("showCadastro").onclick=()=>{ document.getElementById("loginForm").classList.add("hidden"); document.getElementById("cadastroForm").classList.remove("hidden"); };
document.getElementById("showLogin").onclick=()=>{ document.getElementById("cadastroForm").classList.add("hidden"); document.getElementById("loginForm").classList.remove("hidden"); };

document.getElementById("btnLogin").onclick=async ()=>{
  const email=document.getElementById("emailInput").value.trim();
  const senha=document.getElementById("passwordInput").value.trim();
  try{ await signInWithEmailAndPassword(auth,email,senha); }catch(e){ alert("Erro no login"); }
};

document.getElementById("btnCadastro").onclick=async ()=>{
  const email=document.getElementById("cadEmailInput").value.trim();
  const senha=document.getElementById("cadSenhaInput").value.trim();
  const confirma=document.getElementById("cadConfirmaSenhaInput").value.trim();
  if(!email||!senha||senha.length<6||senha!==confirma){ alert("Erro nos dados"); return; }
  try{ await createUserWithEmailAndPassword(auth,email,senha); alert("Cadastro feito! Faça login."); document.getElementById("cadastroForm").classList.add("hidden"); document.getElementById("loginForm").classList.remove("hidden"); }catch(e){ alert("Erro: "+e.message); }
};

document.getElementById("btnSair").onclick=()=>signOut(auth);

document.getElementById("btnAtivo").onclick=()=>{ statusAtual="Ativo"; document.getElementById("statusSelecionado").textContent="Ativo"; };
document.getElementById("btnDesativado").onclick=()=>{ statusAtual="Desativado"; document.getElementById("statusSelecionado").textContent="Desativado"; };

document.getElementById("btnCadastrar").onclick=async ()=>{
  const campos=["nome","apelido","idade","sexo","cidade","corda","tempo","frequencia","telefone","responsavel","autorizacao","data"];
  const dados={status:statusAtual};
  campos.forEach(id=>dados[id]=document.getElementById(id).value||"");
  if(!dados.nome.trim()){ alert("Informe o NOME."); return; }
  try{
    if(editandoDocId) await setDoc(doc(db,"membros",editandoDocId),dados,{merge:true});
    else await addDoc(collection(db,"membros"),dados);
    limparCampos();
  }catch(e){ alert("Erro: "+e.message); }
};

// Filtro de busca
document.getElementById("searchInput").addEventListener("input",()=>{
  const filtro=document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#tabelaMembrosCorpo tr").forEach(tr=>{
    tr.style.display=tr.innerText.toLowerCase().includes(filtro)?"":"none";
  });
});

// Auth state
onAuthStateChanged(auth,user=>{
  if(user){ document.getElementById("authSection").classList.add("hidden"); document.getElementById("membroSection").classList.remove("hidden"); iniciarListenerMembros(); }
  else{ document.getElementById("authSection").classList.remove("hidden"); document.getElementById("membroSection").classList.add("hidden"); if(unsubscribeMembros) unsubscribeMembros(); }
});
</script>
</body>
</html>



